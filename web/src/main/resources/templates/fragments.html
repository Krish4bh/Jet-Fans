<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width= , initial-scale=1.0" />
    <title>fragments</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <link
      rel="stylesheet"
      href="/web/src/main/resources/static/css/fragments.css"
    />

    <link rel="stylesheet" th:href="@{/css/fragments.css}" />
  </head>
  <body>
    <div th:fragment="navbar">
      <nav class="navbar navbar-light fixed-top">
        <div class="container-fluid">
          <div class="row w-100">
            <div
              class="col-1 col-lg-1 d-flex justify-content-center align-items-center"
            >
              <button
                class="btn btn-outline-dark d-none d-lg-block"
                data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasLeft"
                id="offcanvas-btn"
                type="button"
              >
                ‚ò∞
              </button>
            </div>

            <div class="col-12 col-lg-3 text-center">
              <div class="brand-name">
                <a
                  class="logo navbar-brand me-0"
                  th:href="@{/jet-fans/home}"
                  href="../templates/home.html"
                  style="font-family: Dancing Script, cursive"
                  >Jet Fans
                </a>
              </div>
            </div>
            <div class="col-12 col-lg-8 pe-0">
              <div class="right-section d-flex">
                <button
                  class="btn btn-outline-dark d-inline-block d-lg-none align-items-start"
                  data-bs-toggle="offcanvas"
                  data-bs-target="#offcanvasLeft"
                  type="button"
                >
                  ‚ò∞
                </button>

                <ul
                  class="nav d-flex align-items-end ms-auto justify-content-center"
                >
                  <form
                    th:action="@{/search}"
                    class="d-flex align-items-end"
                    method="get"
                  >
                    <div class="form-floating">
                      <input
                        type="search"
                        class="form-control d-none d-lg-inline-block"
                        placeholder="Search"
                        id="search-input"
                        name="keyword"
                      />
                      <label
                        for="search-input"
                        class="form-label d-none d-lg-inline-block"
                        >Search</label
                      >
                      <ul id="search-results">
                        <!-- List items will be dynamically inserted here using JS -->
                      </ul>
                    </div>
                  </form>
                  <li class="nav-item">
                    <a
                      th:href="@{/jet-fans/login}"
                      href="../Pre-Home/authorization.html"
                      class="nav-link d-none d-lg-block"
                      id="LogIn-link"
                      >Log IN</a
                    >
                  </li>
                  <li class="nav-item">
                    <a
                      th:href="@{/jet-fans/contact-us}"
                      href="/WebCode/Post-Home/contact-us.html"
                      class="nav-link d-none d-lg-block"
                      id="ContactUs-link"
                      >Contact Us</a
                    >
                  </li>
                  <li class="nav-item">
                    <a
                      href="#"
                      class="nav-link d-none d-lg-block"
                      id="ShoppingCart-link"
                      data-bs-target="#offcanvas-right"
                      data-bs-toggle="offcanvas"
                      >Shopping Cart</a
                    >
                  </li>
                </ul>
                <ul class="nav d-flex ms-auto m-lg-0">
                  <!-- Search icon (mobile only) -->
                  <li class="nav-item">
                    <a href="#" class="nav-link d-block d-lg-none">
                      <i class="bi bi-search icon"></i>
                    </a>
                  </li>

                  <!-- Login icon -->
                  <li class="nav-item">
                    <a
                      th:href="@{/jet-fans/login}"
                      href="../Pre-Home/authorization.html"
                      class="nav-link d-block d-lg-none"
                    >
                      <i class="bi bi-person icon"></i>
                    </a>
                  </li>

                  <!-- Cart icon -->
                  <li class="nav-item">
                    <a href="#" class="nav-link d-block d-lg-none">
                      <i class="bi bi-cart icon"></i>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div
          class="offcanvas offcanvas-start"
          id="offcanvasLeft"
          tabindex="-1"
          aria-labelledby="offcanvasLabel"
        >
          <div class="offcanvas-header">
            <h4 class="offcanvas-title" id="offcanvasLabel">SideBar</h4>
            <button
              class="btn-close"
              type="button"
              data-bs-dismiss="offcanvas"
              aria-label="close"
            ></button>
          </div>
          <div class="offcanvas-body">
            <p>Some content ...</p>
          </div>
        </div>
      </nav>
      <!-- üõí Shopping Cart Offcanvas -->
      <div class="offcanvas offcanvas-end" id="offcanvas-right" tabindex="-1">
        <div class="offcanvas-header border-bottom">
          <h4 class="mb-0">Your Cart</h4>
          <button
            class="btn-close"
            type="button"
            data-bs-dismiss="offcanvas"
          ></button>
        </div>

        <!-- Cart Body (Dynamic Content Fragment) -->
        <div class="offcanvas-body p-0">
          <div id="cart-body-container" th:fragment="cartFragment">
            <!-- Empty Cart -->
            <div th:if="${#lists.isEmpty(cartItems)}" class="text-center mt-5">
              <i class="bi bi-cart-x" style="font-size: 3rem"></i>
              <p class="mt-3">Your cart is empty.</p>
            </div>

            <!-- Cart With Items -->
            <div th:if="${!#lists.isEmpty(cartItems)}">
              <ul class="list-group list-group-flush mb-3">
                <li
                  class="list-group-item d-flex align-items-center"
                  th:each="item : ${cartItems}"
                >
                  <!-- Product Image -->
                  <img
                    th:if="${!#lists.isEmpty(item.product.images)}"
                    th:src="@{'/Product-Imgs/' + ${item.product.images[0]}}"
                    onerror="this.onerror=null;this.src='/Product-Imgs/blank-img.png';"
                    alt="Product Image"
                    class="me-3 rounded"
                    style="width: 60px; height: 60px; object-fit: cover"
                  />

                  <img
                    th:if="${#lists.isEmpty(item.product.images)}"
                    th:src="@{'/Product-Imgs/' + ${item.product.image}}"
                    onerror="this.onerror=null;this.src='/Product-Imgs/blank-img.png';"
                    alt="Product Image"
                    class="me-3 rounded"
                    style="width: 60px; height: 60px; object-fit: cover"
                  />

                  <!-- Product Details -->
                  <div class="flex-grow-1">
                    <strong th:text="${item.product.title}"></strong><br />
                    <small th:text="'Qty: ' + ${item.quantity}"></small>
                  </div>

                  <!-- Price -->
                  <span
                    th:text="'‚Çπ' + ${item.itemTotalPrice}"
                    class="fw-semibold text-end"
                  ></span>
                </li>
              </ul>

              <!-- Total + Checkout -->
              <div class="border-top pt-3">
                <div class="d-flex justify-content-between mb-3">
                  <strong>Total:</strong>
                  <strong>
                    ‚Çπ<span
                      th:text="${#numbers.formatDecimal(totalPrice, 1, 2)}"
                    ></span>
                  </strong>
                </div>
                <div class="d-grid">
                  <a th:href="@{/checkout}" class="btn btn-success">
                    Proceed to Checkout
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div th:fragment="footer">
      <footer class="bg-dark text-light py-4">
        <div class="container">
          <div class="row">
            <div class="col-md-5">
              <h5>Jet Fans</h5>
              <p>High-performance fans designed for your comfort and style.</p>
            </div>
            <div class="col-md-5">
              <h5>Quick Links</h5>
              <ul class="list-unstyled">
                <li>
                  <a
                    th:href="@{/jet-fans/home}"
                    href="home.html"
                    class="text-light text-decoration-none"
                    >Home</a
                  >
                </li>
                <li>
                  <a
                    th:href="@{/home/shop-now}"
                    href="products.html"
                    class="text-light text-decoration-none"
                    >Products</a
                  >
                </li>
                <li>
                  <a
                    th:href="@{/jet-fans/login}"
                    href="../Pre-Home/authorization.html"
                    class="text-light text-decoration-none"
                    >Login</a
                  >
                </li>
                <li>
                  <a
                    th:href="@{/jet-fans/contact-us}"
                    href="/WebCode/Post-Home/contact-us.html"
                    class="text-light text-decoration-none"
                    >Contact Us</a
                  >
                </li>
              </ul>
            </div>
            <div class="col-md-2">
              <h5>Follow Us</h5>
              <a href="#" class="text-light me-3"
                ><i class="bi bi-facebook"></i
              ></a>
              <a href="#" class="text-light me-3"
                ><i class="bi bi-instagram"></i
              ></a>
              <a href="#" class="text-light me-3"
                ><i class="bi bi-twitter"></i
              ></a>
            </div>
          </div>
          <hr />
          <div class="text-center">
            <small>&copy; 2025 Jet Fans. All Rights Reserved.</small>
          </div>
        </div>
      </footer>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      document
        .getElementById("offcanvas-right")
        .addEventListener("show.bs.offcanvas", function () {
          console.log("üõí Shopping cart offcanvas triggered");

          // Show loading state
          const cartBody = document.getElementById("cart-body-container");
          cartBody.innerHTML = `
        <div class="text-center mt-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading cart...</p>
        </div>
      `;

          fetch("/cart")
            .then((response) => {
              console.log("üì° Response status:", response.status);
              console.log(
                "üì° Response headers:",
                response.headers.get("content-type")
              );

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.text();
            })
            .then((html) => {
              console.log("‚úÖ Cart HTML received (length):", html.length);
              console.log("üì¶ Cart HTML preview:", html.substring(0, 200));

              cartBody.innerHTML = html;
              console.log("‚úÖ Cart content updated in DOM");
            })
            .catch((err) => {
              console.error("‚ùå Error loading cart:", err);
              cartBody.innerHTML = `
            <div class="alert alert-danger m-3">
              <i class="bi bi-exclamation-triangle"></i>
              Failed to load cart. Please refresh the page and try again.
              <br><small>Error: ${err.message}</small>
            </div>
          `;
            });
        });
    </script>
  </body>
</html>
